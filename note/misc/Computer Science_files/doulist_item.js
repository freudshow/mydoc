function generate_report_dialog(t){"undefined"==typeof dui?$.getScript("/js/ui/dialog.js",function(){_generate_report_dialog(t)}):_generate_report_dialog(t)}function _generate_report_dialog(t){function e(t){return t.test(location.pathname)}function n(t){return t.test(location.pathname)}function i(t){return location.pathname.indexOf(t)>=0}var o="8",a=t.type||"";a||(a="content",n(/^\/(subject|game|app)\/\w+/)||e(/movie|music|book/)?(a="subject",i("discussion")&&(a=["comment","subject"])):n(/^\/people\/\w+/)&&(a="account")),a=a instanceof Array?a.join(","):a;var s='<span class="up">举报已提交</span>',r="http://help.douban.com/help/ask",d="/j/misc/report_form?type="+a,c="/misc/audit_report",m='<span>为了便于工作人员进行受理，请您通过<a target="_blank" href="'+r+'">豆瓣帮助中心</a>详细描述内容</span>',u="<h3>提交详细信息</h3>",l=t.report_url?t.report_url:location.href,p=t.reason?t.reason:0,h="#report_value input[type=radio]:checked",f=dui.Dialog({title:t.title?t.title:"选择举报原因",url:t.url?t.url:d,width:t.width?t.width:380,cls:t.cls?t.cls:"report-dialog"});f.report_url=l,f.is_report_dlg_singleton||(f.body.delegate(".btn-report","click",function(){if(p=$(h).val(),"other"==p)f.node.find(".hd").html(u),f.node.find(".bd").html(m),f.update(),f.body.delegate(".bd a","click",function(){f.close()});else{var t="",e=$(".victim-form .victim-msg").hide();if(p===o){if(t=$("#report_value .victim-input").val()||"",!t)return e.text("被冒充帐号 id 不能为空").show();if(t.length>100)return e.text("被冒充帐号 id 最多不能超过 100 个字符").show()}$.post_withck(c,{url:f.report_url,reason:p,extra_msg:t},function(){f.node.find(".hd").hide(),f.node.find(".bd").html(s),f.update(),setTimeout(function(){f.close()},1e3)})}}),f.is_report_dlg_singleton=!0),f.open(),f.body.delegate("input[type=radio]","click",function(){var t=$(h).val();t===o?f.node.find(".victim-form").show():f.node.find(".victim-form").hide()}),f.node.find(".hd").show(),f.update()}function DoulistItem(t,e){return this.id=e,this.$node=t,this.$others=this.$node.find(".others"),this.$actions=this.$node.find(".actions"),this.$text=this.$node.find(".comment-text"),this.count_tmpl='<span class="count {cls}-count">&nbsp;({total})</span>',this}DoulistItem.prototype={constructor:DoulistItem,init:function(){this.bindActionsEvents()},updateCount:function(t,e,n){var i,o=t.next(".count"),a=0|o.attr("data-count");(a||n)&&(i=a+n)?(o.remove(),t.after($(this.count_tmpl.replace(/{cls}/g,e).replace(/{total}/g,i))),o=t.next(".count"),o.attr("data-count",i)):o.remove()},bindActionsEvents:function(){var t=this;this.$node.delegate(".btn","click",function(e){e.preventDefault();var n=$(this).attr("data-action-type");return t[n]($(e.target)),!1}).delegate(".add-more-comments","click",function(t){return t.preventDefault(),$(this).parent().removeClass("comment-posted").find(".comment-text").focus(),!1}).find(".comment-form").bind("submit",function(e){return e.preventDefault(),!!$.trim($(this).find(".comment-text").val())&&(t.addComment(),!1)}),this.$node.delegate(".per-comment","mouseenter mouseleave",function(t){switch(t.type){case"mouseenter":$(this).find(".comment-report").css("visibility","visible");break;case"mouseleave":$(this).find(".comment-report").css("visibility","hidden")}}).delegate(".comment-report a","click",function(t){t.preventDefault();var e=$(this),n=e.closest(".per-comment").data("cid"),i=e.data("url"),o=i.replace(/[^\?]*(?=#)/,"c="+n);generate_report_dialog({report_url:o})})},getAllCommenters:function(){var t=[],e={};window.crt_uid&&(e[window.crt_uid]=1),$("a.commenter",this.$comments[0]).each(function(n,i){var o=i.href.split("/"),a=o[o.length-2];a in e||(t.push({uid:a,avatar:i.getAttribute("data-avatar"),username:i.innerHTML}),e[a]=1)}),this.commenters=t},filteredCommenters:function(t,e,n){for(var i=this.commenters||{},e=e||5,o=[],n=n||{},a=0,s=i.length;a<s&&o.length<e;a++){var r=i[a];r.uid in n||(t?r.username.indexOf(t)>-1?o.push(r):r.uid.indexOf(t)>-1&&o.push(r):o.push(r))}return{users:o}},bindCommentsEvents:function(){var t=this;t.getAllCommenters(),t.$others.delegate("p .btn-del","mouseenter",function(t){$(this).parent().addClass("mover")}).delegate("p .btn-del","mouseleave",function(t){$(this).parent().removeClass("mover")}),t.$text._tagsug_api||Do("tagsug",function(){t.$text.tagsug({max:5,customData:function(){return t.filteredCommenters.apply(t,arguments)}})})},like:function(t){var e=this;t.removeClass("btn"),$.post_withck("/j/doulist/item_like",{id:this.id},function(n){n=$.parseJSON(n),n.r||(t.text("已赞").attr({"data-action-type":"dislike",class:"btn btn-dislike"}),e.updateCount(t,"like",1))})},dislike:function(t){var e=this;$.post_withck("/j/doulist/item_dislike",{id:this.id},function(n){n=$.parseJSON(n),n.r||(t.text("赞").attr({"data-action-type":"like",class:"btn btn-like"}),e.updateCount(t,"like",-1))})},showLikes:function(t){var e=$('<div class="likers"><em></em> <span>赞</span></div>');""!==t&&(e.find("em").html(t),this.$others.find(".likers").remove().end().prepend(e))},showComments:function(t){var e=this;e.$comments=e.$others.find(".comments"),t.text("加载中");var n=e.$comments.find(".comments-items"),i=e.$node.find(".btn-action-reply"),o=t.data("start")||0,a=100;0===o&&t.attr("data-action-type","hideComments"),$.getJSON("/j/doulist/item_comments",{id:e.id,start:o,limit:a},function(s){var r=s.comments,d=s.n_comments;e.showLikes(s.likers),e.$others.show(),i.data("count",d),0===o?(t.text("隐藏回复"),n.html(r)):(t.hide(),n.append(r)),o+=a,o<d&&n.next().text("加载更多").show().data("start",o),e.bindCommentsEvents()})},hideComments:function(t){var e=t.data("count");t.text((e?e:"")+"回复").attr("data-action-type","showComments"),this.$others.hide()},addComment:function(){var t=this,e=t.$node.find(".comment-text"),n=t.$node.find(".btn-action-reply"),i=e.val();e.val(i=t.$text._tagsug_api[0].cleanVal(i)),$.post_withck("/j/doulist/item_comments",{id:t.id,text:i},function(e){e=$.parseJSON(e),t.$comments.find(".comments-items").append(e.comment),n.data("count",n.data("count")+1)}),e.val("").parent().addClass("comment-posted")},deleteComment:function(t){var e=t.attr("data-cid"),n=t.attr("data-id"),i=confirm("确定要删除此回复吗？"),o=this.$node.find('input[name="ck"]').val(),a=this.$node.find(".btn-action-reply");i&&$.ajax({type:"DELETE",url:"/j/doulist/item_comments",data:{ck:o,cid:e,id:n},success:function(){t.parents(".per-comment").remove(),a.data("count",a.data("count")-1)}})}};